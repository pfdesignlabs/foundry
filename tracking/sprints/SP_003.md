# Sprint SP_003 — Ingest Pipeline (F02-INGEST)

**Sprint ID:** SP_003
**Target:** 2026-03-14
**Started:** 2026-02-24
**Status:** ✅ Done — 11/11 work items completed

**Doel:** Volledige ingest pipeline implementeren: chunkers voor alle ondersteunde formaten (MD, PDF, EPUB, JSON, plain text, git, web, audio), embedding writer met contextual prefix (D0004), document summarizer bij ingest (D0008), en foundry ingest CLI command met deduplicatie, recovery, cost estimate en pad/SSRF/audio-grootte validatie.

**Totaal tests:** 272 unit tests groen

---

## ✅ WI_0016 — Chunker base class + Markdown chunker

**Status:** done
**Branch:** `wi/WI_0016-markdown-chunker`

**Uitkomst:**
BaseChunker: abstract chunk(), count_tokens() (4-char approx), _split_fixed_window(), _make_chunks(). MarkdownChunker: H1/H2/H3 heading-aware splits; oversized sections verder gesplitst; fallback naar fixed window zonder headings. 24 unit tests groen.

**Evidence:**
- `src/foundry/ingest/base.py`
- `src/foundry/ingest/markdown.py`
- `tests/unit/ingest/test_markdown_chunker.py`

---

## ✅ WI_0017 — PDF chunker

**Status:** done
**Branch:** `wi/WI_0017-pdf-chunker`

**Uitkomst:**
PdfChunker via pypdf.PdfReader. Import op module-niveau (patchbaar). Default 400 tokens / 20% overlap. 11 unit tests groen.

**Evidence:**
- `src/foundry/ingest/pdf.py`
- `tests/unit/ingest/test_pdf_chunker.py`

---

## ✅ WI_0018 — EPUB chunker

**Status:** done
**Branch:** `wi/WI_0018-epub-chunker`

**Uitkomst:**
EpubChunker via stdlib zipfile + bs4 (html.parser) + html2text (GPL-3.0). OPF spine parsing. XMLParsedAsHTMLWarning gesuppressed. 10 unit tests groen.

**Evidence:**
- `src/foundry/ingest/epub.py`
- `tests/unit/ingest/test_epub_chunker.py`

---

## ✅ WI_0019 — JSON chunker

**Status:** done
**Branch:** `wi/WI_0019-json-chunker`

**Uitkomst:**
JsonChunker: json.loads(), groepering op token budget. Fallback naar fixed window bij ongeldige JSON. 13 unit tests groen.

**Evidence:**
- `src/foundry/ingest/json_chunker.py`
- `tests/unit/ingest/test_json_chunker.py`

---

## ✅ WI_0020 — Plain text chunker

**Status:** done
**Branch:** `wi/WI_0019-json-chunker`

**Uitkomst:**
PlainTextChunker: delegeert naar _split_fixed_window(). 512 tokens / 10% overlap. 9 unit tests groen.

**Evidence:**
- `src/foundry/ingest/plaintext.py`
- `tests/unit/ingest/test_plaintext_chunker.py`

---

## ✅ WI_0021 — Git chunker

**Status:** done
**Branch:** `wi/WI_0021-git-chunker`

**Uitkomst:**
GitChunker: shell=False altijd. URL scheme whitelist via "://" pattern. tempfile.mkdtemp() + os.chmod(0o700) + atexit.register(). GIT_TOKEN gesanitiseerd in errors. 24 unit tests groen.

**Evidence:**
- `src/foundry/ingest/git_chunker.py`
- `tests/unit/ingest/test_git_chunker.py`

---

## ✅ WI_0021b — Web chunker

**Status:** done
**Branch:** `wi/WI_0021b-web-chunker`

**Uitkomst:**
WebChunker: SSRF guard via ipaddress (private/loopback/reserved geblokkeerd). https/http only. Content-Type whitelist. 5MB cap. 30s timeout. Max 3 redirects. 20 unit tests groen.

**Evidence:**
- `src/foundry/ingest/web.py`
- `tests/unit/ingest/test_web_chunker.py`

---

## ✅ WI_0021c — Audio chunker

**Status:** done
**Branch:** `wi/WI_0021c-audio-chunker`

**Uitkomst:**
AudioChunker: os.path.getsize() check voor API call (>25MB hard fail). litellm.transcription(model="openai/whisper-1"). Cost estimate afgedrukt. yes=True slaat prompt over. 13 unit tests groen.

**Evidence:**
- `src/foundry/ingest/audio.py`
- `tests/unit/ingest/test_audio_chunker.py`

---

## ✅ WI_0022 — Embedding writer

**Status:** done
**Branch:** `wi/WI_0022-embedding-writer`

**Uitkomst:**
EmbeddingWriter: context prefix via litellm.completion() per chunk (D0004). Embed f"{prefix}\n\n{chunk.text}". Waarschuwing bij duur context_model. API key check. 10 unit tests groen.

**Evidence:**
- `src/foundry/ingest/embedding_writer.py`
- `tests/unit/ingest/test_embedding_writer.py`

---

## ✅ WI_0022a — Document samenvatting bij ingest

**Status:** done
**Branch:** `wi/WI_0022-embedding-writer`

**Uitkomst:**
DocumentSummarizer: litellm.completion() samenvatting per bron. Upsert in source_summaries. LLM failure non-fatal (lege string). 7 unit tests groen.

**Evidence:**
- `src/foundry/ingest/summarizer.py`
- `tests/unit/ingest/test_summarizer.py`

---

## ✅ WI_0023 — foundry ingest CLI command

**Status:** done
**Branch:** `wi/WI_0023-ingest-cli`

**Uitkomst:**
foundry ingest --source (herhaalbaar), --db, --dry-run, --yes, --recursive, --exclude. Source dispatch op extensie/URL-schema. Deduplicatie via SHA-256 hash. Recovery bij partiële ingest (0 chunks). Cost estimate voor embedding. Directory scanning (direct + recursief, max 10 niveaus). Rich progress spinners. foundry version command toegevoegd (multi-command app structuur). 16 unit tests groen; 272 totaal.

**Evidence:**
- `src/foundry/cli/__init__.py`
- `src/foundry/cli/main.py`
- `src/foundry/cli/ingest.py`
- `tests/unit/cli/test_ingest.py`

---

_Sprint voltooid op 2026-02-24. PR #3 gemerged naar develop._
