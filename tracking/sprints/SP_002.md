# Sprint SP_002 — DB Layer (F01-DB)

**Sprint ID:** SP_002
**Target:** 2026-02-24
**Started:** 2026-02-23
**Status:** ✅ Done — 6/6 work items completed

**Doel:** Volledige database laag implementeren: SQLite schema met chunks + embeddings tabellen, per-model sqlite-vec virtual tables, FTS5 virtual table, source_summaries tabel, migration runner, en repository pattern.

---

## ✅ WI_0012 — SQLite schema: sources + chunks tabellen

**Status:** done
**Branch:** `wi/WI_0012-db-schema`

**Beschrijving:**
SQLite schema aanmaken voor de core tabellen: `sources` (id, path, content_hash, embedding_model, ingested_at) en `chunks` (rowid PK, source_id FK, chunk_index, text, context_prefix, metadata, created_at). Chunks gebruikt rowid als primary key conform D0013.

**Uitkomst:**
Schema aangemaakt met correcte rowid semantiek. Database connection class (Database) en schema initialisatie (initialize()) geïmplementeerd.

**Evidence:**
- `src/foundry/db/schema.py`
- `src/foundry/db/connection.py`
- `src/foundry/db/models.py`

---

## ✅ WI_0012a — Per-model sqlite-vec virtual tables

**Status:** done
**Branch:** `wi/WI_0012a-vec-tables`

**Beschrijving:**
`ensure_vec_table()` aanmaken die per embedding model een `vec_chunks_{model_slug}` virtual table aanmaakt (sqlite-vec). `model_to_slug()` converteert provider/model strings naar geldige tabelnamen.

**Uitkomst:**
ensure_vec_table() geïmplementeerd met slug validatie en dimensions check. Meerdere embedding modellen kunnen naast elkaar bestaan in dezelfde database.

**Evidence:**
- `src/foundry/db/vectors.py`

---

## ✅ WI_0012b + WI_0012c — FTS5 virtual table + source_summaries tabel

**Status:** done
**Branch:** `wi/WI_0012bc-fts5-summaries`

**Beschrijving:**
`chunks_fts` FTS5 virtual table aanmaken voor BM25 full-text search. Expliciete rowid mapping voor synchronisatie met chunks tabel. `source_summaries` tabel aanmaken (source_id, summary_text, generated_at).

**Uitkomst:**
FTS5 gesynchroniseerd met chunks via expliciete rowid INSERT. source_summaries ondersteunt UPSERT (ON CONFLICT DO UPDATE).

**Evidence:**
- `src/foundry/db/schema.py`

---

## ✅ WI_0013 — Migration runner (forward-only)

**Status:** done
**Branch:** `wi/WI_0013-migration-runner`

**Beschrijving:**
Forward-only migration runner implementeren die schema versies bijhoudt in `schema_versions` tabel. Elke migratie is een idempotente SQL functie.

**Uitkomst:**
Migration runner geïmplementeerd met versie tracking. Migrations zijn idempotent via `IF NOT EXISTS` clauses.

**Evidence:**
- `src/foundry/db/migrations.py`

---

## ✅ WI_0015 — Repository pattern (CRUD + vec lookup + FTS5)

**Status:** done
**Branch:** `wi/WI_0015-repository`

**Beschrijving:**
Repository klasse implementeren als enige interface voor alle DB operaties: sources CRUD, chunks CRUD + FTS5 sync, vec embeddings insert + nearest-neighbour search, source summaries CRUD.

**Uitkomst:**
Repository geïmplementeerd met alle methodes. search_vec() en search_fts() returnen (Chunk, score) tuples. add_chunk() synchroniseert automatisch de FTS5 index.

**Evidence:**
- `src/foundry/db/repository.py`
- `tests/unit/db/`

---

_Sprint voltooid op 2026-02-24_
