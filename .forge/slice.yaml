slice:
  id: SP_002
  name: "Phase 1 — Database Layer (F01-DB)"
  started: 2026-02-24
  target: 2026-03-07
  goal: >
    SQLite database schema opzetten met sqlite-vec extensie voor vector search.
    Sources + chunks tabellen, per-model vec tables (ensure_vec_table), FTS5 BM25
    full-text search, source_summaries tabel, forward-only migration runner en
    repository pattern implementeren. Fundament voor alle ingest + retrieval.

workitems:
  - id: WI_0012
    title: "Verbindingslaag + schema: sources + chunks tabellen"
    type: digital
    status: done
    branch: wi/WI_0012-db-schema
    outcome: >
      Database connection layer geïmplementeerd met sqlite-vec extensie.
      Sources, chunks en schema_version tabellen aangemaakt via initialize().
      WAL journal mode, foreign keys, row_factory ingesteld. 16 unit tests groen.
    evidence:
      - src/foundry/db/connection.py
      - src/foundry/db/schema.py
      - src/foundry/db/__init__.py
      - tests/unit/db/test_connection.py
      - tests/unit/db/test_schema.py
    description: >
      SQLite verbinding opzetten met sqlite-vec extensie. Sources tabel:
      id (UUID TEXT PK), path (TEXT relatief), content_hash (TEXT SHA-256),
      embedding_model (TEXT), ingested_at (DATETIME). Chunks tabel:
      rowid (INTEGER implicit PK), source_id (FK), chunk_index (INT),
      text (TEXT), context_prefix (TEXT), metadata (JSON), created_at (DATETIME).
      schema_version tabel voor migration tracking.

  - id: WI_0012a
    title: "Per-model sqlite-vec virtual tables (ensure_vec_table)"
    type: digital
    status: done
    branch: wi/WI_0012a-vec-tables
    depends_on: [WI_0012]
    outcome: >
      ensure_vec_table(), model_to_slug(), vec_table_name() geïmplementeerd.
      Vec tables aangemaakt on-demand, idempotent, meerdere modellen naast elkaar.
      rowid = chunks.rowid (native mapping). 11 unit tests groen.
    evidence:
      - src/foundry/db/vectors.py
      - tests/unit/db/test_vectors.py

  - id: WI_0012b
    title: "FTS5 virtual table voor BM25 full-text search"
    type: digital
    status: done
    branch: wi/WI_0012bc-fts5-summaries
    depends_on: [WI_0012]
    outcome: >
      chunks_fts FTS5 virtual table met porter tokenizer aangemaakt in initialize().
      Expliciete rowid insert (= chunks.rowid). BM25 MATCH search werkt. 3 tests groen.
    evidence:
      - src/foundry/db/schema.py

  - id: WI_0012c
    title: "source_summaries tabel"
    type: digital
    status: done
    branch: wi/WI_0012bc-fts5-summaries
    depends_on: [WI_0012]
    outcome: >
      source_summaries tabel aangemaakt: source_id PK (FK → sources cascade),
      summary_text, generated_at. 3 tests groen (insert, retrieve, cascade delete).
    evidence:
      - src/foundry/db/schema.py

  - id: WI_0013
    title: "Migration runner (forward-only, geen rollbacks)"
    type: digital
    status: done
    branch: wi/WI_0013-migration-runner
    depends_on: [WI_0012, WI_0012a, WI_0012b, WI_0012c]
    outcome: >
      migrations.py: MIGRATIONS lijst + run_migrations() — forward-only, idempotent.
      initialize() in schema.py delegeert naar run_migrations(). Vec tables expliciet
      uitgesloten. Incrementele toepassing getest (pending-only). 10 tests groen.
    evidence:
      - src/foundry/db/migrations.py
      - tests/unit/db/test_migrations.py

  - id: WI_0015
    title: "Repository pattern: chunk CRUD + FTS5 search + vec lookup + summaries"
    type: digital
    status: pending
    depends_on: [WI_0013]
    description: >
      Repository klasse voor alle database operaties: chunk insert/get/delete,
      source insert/get, FTS5 BM25 search, vec lookup (rowid mapping),
      source_summaries CRUD. Vec lookups via: SELECT c.* FROM chunks c WHERE
      c.rowid = vec_result.rowid. Retrieval geeft (chunk, score) tuples terug.

metrics:
  velocity_target: 6
  completed_this_slice: 0
  carry_over_previous: 0
