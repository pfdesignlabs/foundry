# Sprint SP_004 — RAG + Generate (F03-RAG)

**Sprint ID:** SP_004
**Target:** 2026-03-14
**Started:** 2026-02-24
**Status:** ✅ Done — 7/7 work items completed

**Doel:** Volledige RAG + generatie pipeline: hybrid retrieval (BM25 + dense, RRF), HyDE query expansion, context assembler (relevantie scoring, conflict detectie, token budget), LiteLLM client wrapper, prompt templates met `<context>` tags, output writer met footnote attributie, en `foundry generate` CLI command.

**Totaal tests:** 388 unit tests groen (116 nieuw in SP_004)
**PR:** #4 gemerged naar develop

---

## ✅ WI_0024 — Retriever — hybrid BM25 + dense vector search met RRF

**Status:** done
**Branch:** `wi/WI_0024-retriever`

**Beschrijving:**
Hybrid retriever implementeren die BM25 (FTS5) en dense (sqlite-vec) kanalen combineert via Reciprocal Rank Fusion. Vec table validatie bij startup.

**Uitkomst:**
Hybrid retriever met drie modes: `hybrid | dense | bm25`. RRF score(d) = 1/(k + rank_dense) + 1/(k + rank_bm25), k=60. Vec table validatie: RuntimeError als geen embeddings voor geconfigureerd model. 19 unit tests groen.

**Evidence:**
- `src/foundry/rag/retriever.py`
- `tests/unit/rag/test_retriever.py`

---

## ✅ WI_0024a — HyDE query expansion

**Status:** done
**Branch:** `wi/WI_0024-retriever`

**Beschrijving:**
HyDE (Hypothetical Document Embeddings): vóór retrieval genereert een LLM een kort hypothetisch antwoord op de query; dat antwoord wordt ingebed in plaats van de ruwe query.

**Uitkomst:**
HyDE via `litellm.completion()` met `hyde_model`. Hypothetisch antwoord altijd ingebed met `embedding.model` — nooit een apart embedding model. Failure non-fatal: fallback naar ruwe query. Geïntegreerd in `retriever.py` (19 tests samen met WI_0024).

**Evidence:**
- `src/foundry/rag/retriever.py`

---

## ✅ WI_0025 — Context assembler

**Status:** done
**Branch:** `wi/WI_0025-context-assembler`

**Beschrijving:**
Context assembler orkestreert: relevantie scoring per chunk, conflict detectie tussen bronnen, en token budget bewaking.

**Uitkomst:**
- `_score_chunks()`: batch LLM relevantie scoring (0–10); LLM failure → score 10 (non-fatal)
- `_detect_conflicts()`: single LLM call detecteert inhoudelijke tegenstrijdigheden → `ConflictReport` list; failure → leeg
- `_apply_token_budget()`: vult context tot `token_budget` tokens via `count_tokens()`
- `assemble()`: score → filter (threshold) → conflict → token budget → `AssembledContext`
- 24 unit tests groen

**Evidence:**
- `src/foundry/rag/assembler.py`
- `tests/unit/rag/test_assembler.py`

---

## ✅ WI_0026 — LiteLLM client wrapper

**Status:** done
**Branch:** `wi/WI_0026-llm-client`

**Beschrijving:**
Centrale wrapper voor alle LiteLLM calls in de RAG/generate pipeline: completion, embedding, token counting, context window lookup, en API key validatie.

**Uitkomst:**
- `complete()`: `litellm.completion()` met `num_retries` (exponential backoff)
- `embed()`: `litellm.embedding()` met retry
- `count_tokens()`: `litellm.token_counter()` met 4-char fallback (max 1)
- `get_context_window()`: `litellm.get_model_info()` + hardcoded fallback tabel (gpt-4o=128k, claude=200k, default=8192)
- `validate_api_key()`: controleert env var per provider; ollama heeft geen key nodig
- 16 unit tests groen

**Evidence:**
- `src/foundry/rag/llm_client.py`
- `tests/unit/rag/test_llm_client.py`

---

## ✅ WI_0027 — Prompt templates

**Status:** done
**Branch:** `wi/WI_0027-prompt-templates`

**Beschrijving:**
System prompt builder met vaste volgorde (D0016), prompt injection mitigatie via `<context>` tags, en token budget validatie vóór generatie.

**Uitkomst:**
- `build_prompt()`: assembleert `[brief → spec → summaries → <context>chunks</context>]`
- `_load_brief()`: laadt `project.brief` als lokaal bestand; URL → `ValueError` (SSRF preventie); truncatie bij overschrijding `brief_max_tokens`
- `<context>` tags met untrusted-data instructie (prompt injection mitigatie)
- Token budget warning: total > model context window × 0.85 → warning met breakdown; generatie gaat door (geen hard fail)
- Source summaries gecapped op `max_source_summaries` (default 10)
- 23 unit tests groen

**Evidence:**
- `src/foundry/generate/templates.py`
- `tests/unit/generate/test_templates.py`

---

## ✅ WI_0028 — Output writer

**Status:** done
**Branch:** `wi/WI_0028-output-writer`

**Beschrijving:**
Output writer met footnote bronattributie, output pad validatie (path traversal preventie), overwrite beveiliging, en atomisch schrijven.

**Uitkomst:**
- `add_attribution()`: voegt `[^N]: source, chunk N` footnote block toe na document body
- `validate_output_path()`: relatieve traversal (`../../etc/passwd`) → `ValueError`; absolute paden toegestaan (gebruiker koos expliciet)
- `check_overwrite()`: bevestiging bij bestaand bestand; `--yes` slaat over
- `write_output()`: atomisch via `tempfile.mkstemp()` + `os.replace()`; parent dirs aangemaakt
- 22 unit tests groen

**Evidence:**
- `src/foundry/generate/writer.py`
- `tests/unit/generate/test_writer.py`

---

## ✅ WI_0029 — foundry generate CLI command

**Status:** done
**Branch:** `wi/WI_0029-generate-cli`

**Beschrijving:**
`foundry generate` CLI command als operator review tool — genereert een per-feature draft document via de volledige RAG pipeline.

**Uitkomst:**
`foundry generate --topic TEXT --output PATH [--feature NAME] [--db PATH] [--dry-run] [--yes]`

- Feature spec: auto-select bij één approved spec; `--feature` verplicht bij meerdere; optioneel als geen `features/` directory
- Approved spec detectie: bestanden in `features/*.md` die `## Approved` bevatten
- Conflict warnings getoond vóór generatie (niet blokkerend)
- Token budget warning via `build_prompt()`
- Footnote bronattributie via `add_attribution()`
- `--dry-run`: toont retrieval + prompt info zonder LLM call
- Overwrite guard via `check_overwrite()`
- 12 unit tests groen; 388 totaal

**Evidence:**
- `src/foundry/cli/generate.py`
- `src/foundry/cli/main.py`
- `tests/unit/cli/test_generate.py`

---

_Sprint voltooid op 2026-02-24. PR #4 gemerged naar develop._
